<!DOCTYPE html>
<html>
<head>
    <title>crowdify - playlist select</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script type='text/javascript' src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script type='text/javascript' src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://developer.spotify.com/web-api/static/css/cached.css">
    
    <style type='text/css'>
        body {
            padding: 20px;
        }

        #search-form, .form-control {
            margin-bottom: 20px;
        }
    </style>
      
    <script type='text/javascript'>//<![CDATA[ 
        window.onload=function() {
            // find template and compile it
            var templateSource = document.getElementById('results-template').innerHTML;
            var template = Handlebars.compile(templateSource);
            var resultsPlaceholder = document.getElementById('results');
            var url_base = 'http://localhost:8080';

            var searchPlaylists = function () {
                $.ajax({
                    url: 'https://api.spotify.com/v1/users/' + qs['user'] + '/playlists',
                    headers: {
                        Authorization: 'Bearer ' + qs['access_token']
                    },
                    success: function (response) {
                        // add to the results div object
                        console.log(response);
                        resultsPlaceholder.innerHTML = template(response);
                    }
                });
            };

            // split the query string to a dictionary
            var qs = (function(a) {
                // no querysting
                if (a == "") {
                    console.error("missing querysting");
                    return {};
                }

                pairs = a.split('&');
                b = {}
                for (var i = 0; i < pairs.length; i++) {
                    pair = pairs[i].split('=', 2);
                    if (pair.length == 1)
                        b[pair[0]] = "";
                    else
                        b[pair[0]] = pair[1];
                }
                return b;
            })(window.location.hash.substring(1));

            searchPlaylists();

            results.addEventListener('click', function (e) {
                var target = e.target;
                if (target !== null && target.classList.contains('playlist')) {
                    // make a request to the server and store the information
                    var playlist_id = target.getAttribute('playlist-id');
                    // we need the owner (usually the user) in case the
                    // playlist is collaborative and the user is not the
                    // creator 
                    var owner_id = target.getAttribute('owner-id');

                    console.log('sending request to playlist-uri %s owned by %s to be controlled by %s', playlist_id, owner_id, qs['user']);
                    $.ajax({
                        url: url_base + '/add_account',
                        data: {
                            user: owner_id,
                            playlist: playlist_id,
                            access_token: qs['access_token'],
                            refresh_token: qs['refresh_token']
                        },
                        success: function (response) {
                            console.log(response);
                            if (response.redirect) {
                                window.location.href = response.redirect;
                            }
                        }
                    });
                }
            });
        }//]]>  
    </script>
</head>

<body>
    <div class="container">
        <h1>Pick a Playlist</h1>
        <div id="results"></div>
    </div>
    <script id="results-template" type="text/x-handlebars-template">
        {{#each items}}
        <p>
        <button type="button" playlist-id="{{id}}" owner-id="{{owner.id}}" class="playlist btn btn-secondary"> 
            {{name}}
        </button>
        </p>
        {{/each}}
    </script>
</body>
</html>
